# 用 Gson 序列化和反序列化列表

> 原文：<https://web.archive.org/web/20220930061024/https://www.baeldung.com/gson-list>

## **1。简介**

在本教程中，我们将探索一些高级的[序列化](/web/20221107092027/https://www.baeldung.com/gson-serialization-guide)和[反序列化](/web/20221107092027/https://www.baeldung.com/gson-deserialization-guide)案例，用于使用 [Google 的 Gson 库](https://web.archive.org/web/20221107092027/https://github.com/google/gson)的`List`。

## **2。对象列表**

一个常见的用例是序列化和反序列化 POJOs 列表。

考虑一下这个类:

[PRE0]

下面是我们如何连载`List<MyClass>`:

[PRE1]

正如我们所见，序列化相当简单。

然而，反序列化是棘手的。这是一种不正确的做法:

[PRE2]

在这里，**尽管在反序列化后我们会得到一个大小为 2 的`List`，但它不会是`MyClass`** 的`List`。因此，6 号线抛出`ClassCastException`。

**Gson 可以序列化任意对象的集合，但是在没有附加信息的情况下无法反序列化数据。这是因为用户没有办法指出结果对象的类型。**相反，在反序列化时，`Collection`必须是特定的泛型类型。

反序列化`List`的正确方式应该是:

[PRE3]

这里，**我们使用 Gson 的`TypeToken`来确定要反序列化的正确类型——`ArrayList<MyClass>`**。用于获取`listOfMyClassObject`的习语实际上定义了一个匿名的本地内部类，包含一个返回完全参数化类型的方法`getType()`。

## **3。多态对象列表**

### **3.1。问题**

考虑一个动物等级的例子:

[PRE4]

我们如何序列化和反序列化`List<Animal>`？我们可以像在上一节中一样使用`TypeToken<ArrayList<Animal>>`。然而，Gson 仍然无法确定存储在列表中的对象的具体数据类型。

### **3.2。使用自定义反序列化器**

解决这个问题的一个方法是向序列化的 JSON 添加类型信息。我们在 JSON 反序列化过程中尊重类型信息。为此，我们需要编写自己的自定义序列化程序和反序列化程序。

首先，我们将在基类`Animal`中引入一个名为 `type`的新`String`字段。它存储它所属的类的简单名称。

让我们看一下我们的示例类:

[PRE5]

[PRE6]

[PRE7]

序列化将像以前一样继续工作，没有任何问题:

[PRE8]

为了反序列化列表，我们必须提供一个定制的反序列化器:

[PRE9]

这里，`animalTypeRegistry`映射维护类名和类类型之间的映射。

在反序列化过程中，我们首先提取出新添加的`type`字段。使用这个值，我们在`animalTypeRegistry`映射上进行查找，以获得具体的数据类型。这个数据类型然后被传递给`fromJson()`。

让我们看看如何使用我们的自定义反序列化器:

[PRE10]

### **3.3。使用`RuntimeTypeAdapterFactory`**

编写定制反序列化器的另一种方法是使用 [Gson 源代码](https://web.archive.org/web/20221107092027/https://github.com/google/gson/blob/master/extras/src/main/java/com/google/gson/typeadapters/RuntimeTypeAdapterFactory.java)中的`RuntimeTypeAdapterFactory`类。然而，**并没有被图书馆公开给用户使用**。因此，我们必须在 Java 项目中创建该类的副本。

完成后，我们可以用它来反序列化我们的列表:

[PRE11]

请注意，底层机制仍然是相同的。

我们仍然需要在序列化过程中引入类型信息。类型信息可以在以后的反序列化过程中使用。**因此，这个解决方案的每个类中仍然需要字段`type`。**我们不需要编写自己的反序列化器。

`RuntimeTypeAdapterFactory`根据传递给它的字段名和注册的子类型提供正确的类型适配器。

## **4。结论**

在本文中，我们看到了如何使用 Gson 序列化和反序列化对象列表。

像往常一样，代码可以在 GitHub 上的[处获得。](https://web.archive.org/web/20221107092027/https://github.com/eugenp/tutorials/tree/master/json-modules/gson)