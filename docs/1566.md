# 将 Docker 映像推送到自托管注册表

> 原文:[https://web . archive . org/web/20220930061024/https://www . bael dung . com/ops/docker-push-image-self-hosted-registry](https://web.archive.org/web/20220930061024/https://www.baeldung.com/ops/docker-push-image-self-hosted-registry)

## 1.概观

本教程将演示如何将 Docker 映像推送到自托管的 Docker 注册表中。首先，我们将探索什么是自托管注册中心，以及它与公共注册中心有何不同。然后，我们将学习如何标记我们想要推送到自托管注册表的图像。最后，我们将了解如何实际推送这些图像。

## 2.自托管 Docker 注册表

Docker 注册表是一种管理容器映像存储库的服务。它允许我们创建存储库、推送和拉取图像以及管理存储库访问。虽然许多注册中心是作为云服务提供的，但是注册中心也可以是自托管的。

当通过云提供注册中心时，我们不必关心它的托管和维护。我们只需注册服务，然后使用提供的功能。云托管的 **Docker 注册中心也称为公共注册中心。** Docker Hub 是一个众所周知的公共注册中心的例子。

然而，如果一个公司有特殊的需求，公共注册可能不是一个选择。无法使用公共注册中心的公司通常拥有自己托管的注册中心，他们可以根据自己的需求进行定制。例如，一家公司可能有一个隐私政策，要求只能通过公司的内部网络访问存储库。或者，公司可能需要对其图像运行特定的漏洞扫描。

## 3.为自托管注册表标记图像

我们必须以特定的方式标记图像，然后才能将它们推送到自托管注册表。让我们来学习如何恰当地标记图像。

### 3.1.图像名称模式

推送图像时，**图像名称定义了图像将被推送至何处**。这就是为什么，为了将图像推送到自托管的注册中心，我们使用正确的命名模式是至关重要的。**镜像名称必须包含注册主机、端口和存储库名称**，并且可以选择在其后跟随一个版本标记:

```
[registry host]:[registry port]/[repository name]:[tag name]
```

假设我们有一个运行在`localhost`上并监听端口`5000`的注册中心。这里有一个我们想推送到注册中心的`my-fancy-app`存储库的图像版本`1.0.0`的名称示例:

```
localhost:5000/my-fancy-app:1.0.0
```

我们将在本文的其余部分使用这个例子。

既然我们知道了要应用什么命名模式，我们就可以为我们的自托管注册中心准备一个映像了。首先，我们将看到如何用正确的名称构建一个新的映像。然后，我们将学习如何通过重命名来准备现有的图像。

### 3.2.标记新图像

如果我们正在构建一个新的映像，并且已经准备好了一个应用程序和 Dockerfile 文件，我们可以**使用`docker build`命令**的`-t`标志，这样这个映像就会以适当的名称创建。使用上一节中的示例，该命令将是:

```
$ docker build -t localhost:5000/my-fancy-app:1.0.0 .
```

这将使用正确的名称标记新图像，后跟可选的版本标记。点“.”表示我们正在与 Dockerfile 相同的目录中执行命令。

### 3.3.重新标记现有图像

如果我们想要将一个现有的图像推送到我们自托管的注册中心，我们首先需要用一个新的别名来标记该图像，该别名与我们上面描述的命名模式相匹配。**我们可以用`docker tag`命令**重新标记图像:

```
docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]
```

例如，假设我们想要将一个名为`my-fancy-app:1.0.0` 的现有图像推送到我们的自托管注册表中。我们将简单地使用`docker tag`命令用一个匹配该注册表的新别名来标记它:

```
$ docker tag my-fancy-app:1.0.0 localhost:5000/my-fancy-app:1.0.0
```

## 4.推送图像

一旦我们正确地标记了一个图像，我们就可以把它推送到我们自托管的注册表中。

**公司通常需要身份验证来保护他们的自托管注册表。**在这种情况下，我们首先需要使用`docker login`命令登录:

```
docker login [OPTIONS] [SERVER]
```

对于托管在`localhost:5000`上的自托管注册表，命令是:

```
$ docker login localhost:5000
```

登录后，我们使用`docker push`命令将图像推送到我们自托管的注册表中:

```
docker push [OPTIONS] NAME[:TAG]
```

让我们看一下推送我们在上面几节中准备的映像的命令:

```
$ docker push localhost:5000/my-fancy-app:1.0.0
```

## 5.验证推送

最后一步是验证图像现在在我们的自托管注册表中可用。为此，我们将从注册表中提取图像，但是**我们必须首先通过运行`docker image rm` 命令**删除我们缓存的本地图像:

```
$ docker image rm localhost:5000/my-fancy-app:1.0.0
```

让我们通过列出我们所有的本地图像并检查我们的图像不在那里来验证我们是否删除了图像:

```
$ docker images
```

接下来，让我们使用`docker pull` 命令从自托管注册表中提取图像:

```
$ docker pull localhost:5000/my-fancy-app:1.0.0
```

通过再次列出所有本地映像，我们可以验证我们的映像是否成功地从我们的自托管注册表中提取:

```
$ docker images
REPOSITORY                  TAG   IMAGE ID     CREATED        SIZE 
localhost:5000/my-fancy-app 1.0.0 d33a5b65c0f5 20 minutes ago 326MB
```

## 6.结论

在本文中，我们已经了解了什么是自托管 Docker 注册中心，以及为什么我们可能会使用它们。我们还探讨了如何准备一个映像——无论它是预先存在的映像还是我们正在构建的新映像——以便我们可以将它推送到自托管注册表。最后，我们学习了如何将正确标记的图像推送到我们的示例注册表中。