# Redis Sentinel vs 群集

> 原文:[https://web . archive . org/web/20220930061024/https://www . bael dung . com/redis-sentinel-vs-clustering](https://web.archive.org/web/20220930061024/https://www.baeldung.com/redis-sentinel-vs-clustering)

## 1.概观

在本教程中，我们将讨论 Redis，更重要的是，它的两种不同的部署策略，Redis Sentinel 和 Redis Cluster。然后，我们将讨论这些策略之间的差异及其细微差别。

最后，我们希望对 Redis 有足够的了解，以判断哪种部署策略更能满足我们的需求。

## 2.导言要背道而驰

Redis 是一个开源的内存数据结构存储，可以用作键值数据库、缓存和许多其他用例。它旨在提供数据的高速访问。

我们的目标是分析和比较两种不同的策略，Redis Sentinel 和 Redis Cluster。

Redis Sentinel 是 Redis 提供的一个独立流程。它的目标是监控 Redis 实例、提供通知功能、主发现、失败时的自动故障转移，以及通过多数投票进行主选举。换句话说，Sentinel 是一个分布式系统，为 Redis 提供了额外的功能，如高可用性和故障转移。 Redis Sentinel 将部队与标准 Redis 部署相结合。

Redis 集群是一种可进一步扩展的部署策略。与 Sentinel 类似，它提供故障转移、配置管理等功能。**区别在于分片功能，它允许我们将容量几乎线性地扩展到 1000 个节点。**

## 3.基本概念

为了帮助我们理解这两种策略的细微差别，让我们首先尝试内化一些基本概念和构建模块。

有些概念可能与 Redis 集群或 Sentinel 没有严格的联系。然而，其他人可能对两者都适用，但了解他们将有助于我们理解 Redis。

### 3.1.数据库

Redis 支持多个逻辑数据库。尽管仍然保存在同一个文件中，但它们允许用户在每个数据库中拥有不同值的相同键。它们就像不同的数据库模式。

**默认情况下，Redis 提供 16 个逻辑数据库，但是用户可以更改这个数字**。这种数据库通过从零开始的索引来识别。

**另一个需要强调的要点是 Redis 是一个单线程数据存储。因此，所有的数据库操作都进入同一个执行管道。**

### 3.2.哈希槽

Redis 集群的工作方式与标准集群略有不同。**例如，为了自动分片数据并将其分布到集群的各个节点，Redis 集群使用所谓的哈希槽**。

Redis 集群不使用一致散列来完成分发工作。相反，它使用散列槽。

**每个集群有 16384 个哈希槽，这些哈希槽可以分布在所有节点**、**上，在所有操作期间，Redis 客户端通过取密钥的 [CRC16](https://web.archive.org/web/20221223072518/https://redis.io/docs/reference/cluster-spec/#key-distribution-model) 模 16384** 来使用密钥计算哈希。然后，它使用它将命令路由到正确的节点。

每个节点都有一个分配给它的哈希片段子集，并且可以使用重新共享或重新平衡操作在节点之间移动片段。此外，考虑到这种方法的特殊性，Redis 集群不允许每个节点有多个逻辑数据库。**因此，在每个节点**中只有数据库零可用。

最后，由于散列槽中键的分布， **Redis 集群在涉及多个键操作时有一个警告。这些操作仍然可用，尽管所有涉及的键必须属于同一个散列槽。否则，Redis 拒绝该请求。**

### 3.3\. Hash Tags

这个机制帮助用户保证一组密钥进入同一个哈希槽。为了定义一个[散列标签](https://web.archive.org/web/20221223072518/https://redis.io/docs/reference/cluster-spec/#hash-tags)，用户必须在一个键的括号之间添加一个子串。例如，键 app1{user:123}.mykey1 和 app1{user:123}.mykey2 将进入同一个散列块。

通过这样做，Redis 只使用子串来生成键的散列，从而将所有键路由到同一个散列槽。

### 3.4.异步复制

Redis 集群和标准集群都使用异步复制。这意味着 **Redis 不会等待副本来确认写入。**

此外，总会有一个微小的时间窗口，故障可能会导致已确认的写入丢失。但是，有一些方法可以通过尽可能限制这个时间窗口来降低这种风险。但是同样，风险总是存在的，所以 Redis 不保证[强一致性](https://web.archive.org/web/20221223072518/https://redis.io/docs/manual/scaling/#redis-cluster-consistency-guarantees)。

### 3.5.故障切换

Redis 提供了不同的机制来处理故障并保证一定程度的容错。Redis 集群和使用 Sentinel 的标准集群都有这样的工具。这种系统带有基于健康检查和超时的故障检测器。

在 Redis 集群的情况下，它使用[心跳和 gossip 协议](https://web.archive.org/web/20221223072518/https://redis.io/docs/reference/cluster-spec/#fault-tolerance)。出于本文的目的，我们不会深入探讨这些问题。但总而言之，每个节点都与其他节点对话，交换带有元数据的数据包，并计算一些超时，以防特定节点没有响应。

关于 Sentinel，每个 Sentinel 实例监控一个 Redis 实例。Sentinel 实例之间也相互通信，并且基于配置，[可能由于通信和超时问题而执行故障转移。](https://web.archive.org/web/20221223072518/https://redis.io/docs/manual/sentinel/#configuring-sentinel)

### 3.6.主选举

同样，这两个实现都有投票策略，并且这个过程有不同的阶段。但是主要目标是决定是否应该进行故障转移以及提升哪一个。

Sentinel 使用法定人数的概念。法定人数是需要找到关于主节点是否可达的共识的哨兵实例的最小数量。

一旦发生这种情况，主服务器将被标记为失败，最终，如果可能，将启动故障转移过程。之后，至少大多数 Sentinel 必须授权故障转移，并选出负责故障转移的 Sentinel 实例。然后，此实例选择最佳读取复制副本进行升级，并执行故障切换。最后，实例开始向其他 Sentinel 实例广播新的设置。

**当使用 Redis 集群**时，流程会有所改变。这一次，复制节点负责。正如我们之前提到的，在这种情况下，所有节点之间都进行通信，因此一旦一个或多个副本检测到故障，它们就可以开始选举。下一步是请求大师们的投票。投票完成后，副本将获得故障转移权限。

鉴于这些投票机制的性质， **Redis 建议在集群中始终使用奇数个节点，这适用于两种实现。**

### 3.7.网络分区

Redis 可以经受许多不同的故障，它的设计足够健壮，即使在节点停机时也能提供连续的操作。然而，我们可能面临的一个关键问题场景是所谓的网络分区。由于它的拓扑结构，Redis 在处理这类问题时面临着挑战。

所谓的大脑分裂是这一类中最直接的问题之一`.`让我们举以下例子:

[![Split brain step 1](../Images/97ee414d207ae56ae82061447441d85e.png)](/web/20221223072518/https://www.baeldung.com/wp-content/uploads/2022/10/split_brain_step1.png) 
在这里，我们可以看到，我们有一个网络分区，一个客户端正在与我们的集群通信，现在只能到达两个实例 1 和 2。

另一方面，另一个客户端与另一个分区进行通信，其中在该分区中只有 3 和 4 是可到达的。假设我们的法定人数是 2，在某个时候，故障转移将发生在右侧，我们将得到结果:
[![Split brain step 2](../Images/c2a1e2a886a6b49fa1adc74e935da8b3.png)](/web/20221223072518/https://www.baeldung.com/wp-content/uploads/2022/10/split_brain_step2.png)

现在，我们有两个集群(Redis 3 已经升级为 master)。在某个时候，当网络分区消失时，如果在分离过程中在两端用不同的值写入了相同的密钥，集群可能会出现问题。

我们可以将相同的原则应用于 Redis 集群，结果将是相似的。**这说明了为什么推荐奇数，为什么使用像`min-replicas-to-write` 这样的配置`.`这个想法总是有多数和少数分区，只有多数分区能够执行故障转移。**

正如我们可以想象的那样，在网络划分期间，还有许多其他可能的场景。因此，无论我们选择哪一个选项，在设计我们的集群时，理解并牢记这一点是至关重要的。

## 4.Redis Sentinel vs 群集

下表比较了它们的一些主要特性:

[![Comparing Redis standard with Sentinel vs Cluster](../Images/66ae8e51b67decad0e17d4ef1b520cfd.png)](/web/20221223072518/https://www.baeldung.com/wp-content/uploads/2022/10/redis_standard_with_sentinel_vs_cluster-1024x472-1.png)

我们可以通过使用 Redis 集群的所有细节和细微差别以及与 Redis Sentinel 相结合的标准实现来连接这些点。

我们可以断定 Sentinel 提供了监控、容错和通知功能。它也是一个配置提供者。此外，**它可以提供认证能力和客户服务发现。它可以为您的集群提供 16 个逻辑数据库、异步复制和高可用性。**

尽管如此，**Redis 的单线程性质和垂直扩展的障碍是 Sentinel 扩展能力的限制因素**。但是，对于中小型项目，它可能是理想的。

使用 Sentinel 部署需要更少的节点也是事实。所以，性价比更高。

值得一提的是，我们还可以通过使用读取副本来进一步扩展只读操作。

**Redis 集群是一个完全分布式的实施，具有自动分片功能(水平扩展功能)，旨在实现高性能和线性扩展至 1000 个节点**。此外，只要主设备的所有数据都可以从多数方(通过主设备或副本电缆进行故障转移)到达，它就提供了合理程度的写入安全性和幸免于灾难的方法。

另一点是，在网络分区期间，集群的少数部分将停止接受请求。另一方面，Sentinel 部署可能会继续部分工作，这取决于配置。如前所述，集群的可用性和容错性取决于集群的配置和组成。

集群版本还提供了重新配置主节点和副本节点之间的映射的能力，以便在单个节点发生多个独立故障时重新平衡。然而，同样地，更健壮的集群需要更多的节点，因此成本也更高。此外，管理更多节点和平衡碎片是不可忽视的额外复杂性。

**综上所述，Redis Cluster 在需要高吞吐量和扩展能力的大数据集大型部署中大放异彩。**

## 5.结论

在本文中，我们讨论了 Redis 及其不同的实现，Redis 集群和使用 Sentinel 的 Redis 标准。

我们还了解了该解决方案的所有基本构造块，以及如何使用它们来最大限度地利用它们。我们希望有工具来根据用例决定使用哪个选项。